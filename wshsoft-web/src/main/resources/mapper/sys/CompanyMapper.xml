<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wshsoft.sys.mapper.CompanyMapper">
    <resultMap type="Company" id="CompanyResult">
        <result property="companyId"    column="company_id"    />
        <result property="parentId"    column="parent_id"    />
        <result property="ancestors"    column="ancestors"    />
        <result property="companyName"    column="company_name"    />
        <result property="orderNum"    column="order_num"    />
        <result property="leader"    column="leader"    />
        <result property="phone"    column="phone"    />
        <result property="email"    column="email"    />
        <result property="status"    column="status"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
        <result property="parentName" column="parent_name" />
    </resultMap>

    <sql id="selectCompanyVo">
        select company_id, parent_id, ancestors, company_name, order_num, leader, phone, email, status, del_flag, create_by, create_time, update_by, update_time, remark from sys_company
    </sql>

    <select id="selectCompanyList" parameterType="Company" resultMap="CompanyResult">
        <include refid="selectCompanyVo"/>
        <where>  
            <if test="companyName != null  and companyName != ''"> AND company_name like concat('%', #{companyName}, '%')</if>
            <if test="leader != null  and leader != ''"> AND leader = #{leader}</if>
            <if test="status != null  and status != ''"> AND status = #{status}</if>
            <if test="createTime != null "> AND create_time &gt;= #{createTime}</if>
        </where>
        order by parent_id
    </select>
    <select id="selectCompanyById" parameterType="Long" resultMap="CompanyResult">
        select t.company_id, t.parent_id, t.ancestors, t.company_name, t.order_num, t.leader, t.phone, t.email, t.status, t.del_flag, t.create_by, t.create_time, t.update_by, t.update_time, t.remark, p.company_name as parent_name
        from sys_company t
        left join sys_company p on p.company_id = t.parent_id
        where t.company_id = #{companyId}
   </select>
    <select id="selectCompanyCount" parameterType="Long" resultType="int">
        select count(1) from sys_company
        where del_flag = '0'
        <if test="companyId != null and companyId != 0"> and company_id = #{companyId} </if>
        <if test="parentId != null and parentId != 0"> and parent_id = #{parentId} </if>
    </select>
    
    <select id="checkCompanyNameUnique" resultMap="CompanyResult">
        <include refid="selectCompanyVo"/>
        where company_name=#{companyName} and parent_id = #{parentId}
    </select>
     <update id="updateCompanyChildren" parameterType="java.util.List">
      update sys_company set ancestors =
      <foreach collection="companys" item="item" index="index"
          separator=" " open="case company_id" close="end">
          when #{item.companyId} then #{item.ancestors}
      </foreach>
      where company_id in
      <foreach collection="companys" item="item" index="index"
          separator="," open="(" close=")">
          #{item.companyId}
      </foreach>
   </update>
   
   <update id="updateCompanyStatus" parameterType="Long">
       update sys_company
       <set>
           <if test="status != null and status != ''">status = #{status},</if>
       </set>
       where company_id in (${ancestors})
   </update>
   
    <select id="selectChildrenCompanyById" parameterType="Long" resultMap="CompanyResult">
        <include refid="selectCompanyVo"/>
         where find_in_set(#{companyId}, ancestors)
    </select>
    
    <select id="checkCompanyExistUse" parameterType="Long" resultType="int">
        select count(1) from sys_user where company_id = #{companyId} and del_flag = '0'
    </select>
</mapper>